<!--
SPDX-FileCopyrightText: 2017-present Tobias Kunze
SPDX-License-Identifier: AGPL-3.0-only WITH LicenseRef-Pretalx-AGPL-3.0-Terms

This file contains Apache-2.0 licensed contributions copyrighted by the following contributors:
SPDX-FileContributor: Florian Mösch
-->

{% extends "orga/submission/base.html" %}

{% load i18n %}
{% load rich_text %}
{% load rules %}
{% load static %}
{% load thumbnail %}

{% block stylesheets %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "orga/css/ui/dragsort.css" %}">
{% endblock stylesheets %}

{% block scripts %}
    {{ block.super }}
    <script defer src="{% static "orga/js/ui/dragsort.js" %}"></script>
{% endblock scripts %}

{% block submission_title %}{% translate "Speakers" %} :: {% endblock submission_title %}

{% block submission_content %}

    <span id="vars" remoteUrl="{{ request.event.organiser.orga_urls.user_search }}"></span>

    {% has_perm "person.orga_list_speakerprofile" request.user request.event as can_view_speakers %}
    {% has_perm "submission.update_submission" request.user submission as can_edit_speakers %}
    {% has_perm "mail.send_queuedmail" request.user request.event as can_send_mails %}
    {% has_perm "person.mark_arrived_speakerprofile" request.user request.event as can_mark_speaker %}
    {% if can_edit_speakers %}<div class="alert">
        <form method="POST" class="form d-flex w-100 flex-column">
            {% csrf_token %}
            <div class="d-flex flex-row">
                <div class="w-50 hide-optional mr-4">{{ form.email.as_field_group }}</div>
                <div class="w-50">{{ form.name.as_field_group }}</div>
            </div>
            <div class="d-flex flex-row hide-optional">
                <div class="w-50 hide-optional mr-4">{% if form.locale %}{{ form.locale.as_field_group }}{% endif %}</div>
                <div class="w-50 mt-4"><button type="submit" class="btn btn-sm btn-success btn-block btn-lg mt-2"><i class="fa fa-plus"></i> {% translate "Add speaker" %}</button></div>
            </div>
        </form>
    </div>{% endif %}

    {% if speakers|length > 1 and can_edit_speakers %}
        <div dragsort-url="{{ submission.orga_urls.reorder_speakers }}">
    {% endif %}
    {% for speaker in speakers %}
        {% if speakers|length > 1 and can_edit_speakers %}<div class="speaker-sort-wrapper" dragsort-id="{{ speaker.role.pk }}">{% endif %}
        <div class="card {% if speakers|length <= 1 or not can_edit_speakers %}mb-3{% endif %} speaker-card"><div class="card-body">
            <h3 class="card-title">
                {% if can_view_speakers %}
                    <a href="{% url "orga:speakers.view" event=request.event.slug code=speaker.user.code %}">
                {% endif %}
                {{ speaker.user.get_display_name }}
                {% if can_view_speakers %}
                    </a>
                {% endif %}
                {% if speaker.user.avatar and request.event.cfp.request_avatar %}
                    <div class="float-right speaker-detail">
                        <a href="{{ speaker.user.avatar.url }}" data-lightbox>
                            <img loading="lazy" width="100%" src="{{ speaker.user.avatar|thumbnail:"default" }}" alt="{% translate "The speaker’s profile picture" %}">
                        </a>
                    </div>
                {% endif %}
            </h3>
            {% if request.event.cfp.request_biography %}
                <div class="card-text speaker-detail">
                    <h5>{% translate "Biography" %}:</h5>
                    {{ speaker.profile.biography|rich_text|default:"-" }}
                </div>
            {% endif %}
            <div class="card-text speaker-detail">
                {% if speaker.other_submissions %}
                    <h5>{% translate "Other proposals by this speaker:" %}</h5>
                    <ul>
                        {% for submission in speaker.other_submissions %}
                            <li>
                                <a href="{{ submission.orga_urls.base }}">{{ submission.title }}</a>
                                {% include "cfp/event/fragment_state.html" with state=submission.state as_badge=True %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            <div class="row w-100 ml-3 pr-3 align-items-end justify-content-end gap-2">
                {% if can_edit_speakers %}
                    {% if can_mark_speaker and submission.state in 'accepted,confirmed' %}
                        {% include "orga/includes/mark_speakers_arrived.html" with speaker=speaker.profile %}
                    {% endif %}
                    {% if can_send_mails %}
                        <a class="btn btn-outline-info" role="button" href="{{ speaker.orga_urls.send_mail }}">
                            <i class="fa fa-envelope"></i>
                            {% translate "Send email" %}
                        </a>
                    {% endif %}
                    <a href="{% url "orga:speakers.view" event=request.event.slug code=speaker.user.code %}"
                       role="button" class="btn btn-info">
                        <i class="fa fa-edit"></i> {{ phrases.base.edit }}
                    </a>
                    {% if speakers|length > 1 %}
                        <div role="button" class="btn btn-info dragsort-button" draggable="true" title="{% translate "Drag to reorder" %}">
                            <i class="fa fa-bars"></i> {% translate "Change order" %}
                        </div>
                    {% endif %}
                    <a href="{{ submission.orga_urls.delete_speaker }}?id={{ speaker.user.id }}"
                       role="button" class="btn btn-danger">
                        <i class="fa fa-trash"></i> {% translate "Remove" %}
                    </a>
                {% endif %}
            </div>
        </div></div>
        {% if speakers|length > 1 and can_edit_speakers %}</div>{% endif %}
    {% endfor %}
    {% if speakers|length > 1 and can_edit_speakers %}
        </div>
    {% endif %}

    {% if invitations %}
        <h4 class="mt-4">{% translate "Pending Invitations" %}</h4>
        {% for invitation in invitations %}
            <div class="card mb-3 speaker-card"><div class="card-body">
                <h3 class="card-title">
                    <i class="fa fa-clock"></i> {{ invitation.email }}
                </h3>
                <p class="card-text text-muted ml-2">
                    {% translate "Invited on" %} {{ invitation.created|date:"SHORT_DATE_FORMAT" }}
                </p>
                {% if can_edit_speakers %}
                    <div class="row mr-2 justify-content-end">
                        <a href="{{ submission.orga_urls.retract_invitation }}?id={{ invitation.id }}"
                           class="btn btn-danger ml-2">
                            <i class="fa fa-trash"></i> {% translate "Remove" %}
                        </a>
                    </div>
                {% endif %}
            </div></div>
        {% endfor %}
    {% endif %}
{% endblock submission_content %}
